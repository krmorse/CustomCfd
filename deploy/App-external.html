<!DOCTYPE html>
<html>
<head>
    <title>CustomCfd</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("Settings",{singleton:!0,getSettingsFields:function(context){return[{name:"types",xtype:"rallycombobox",plugins:["rallyfieldvalidationui"],allowBlank:!1,editable:!1,autoSelect:!1,validateOnChange:!1,validateOnBlur:!1,fieldLabel:"Types",multiSelect:!0,shouldRespondToScopeChange:!0,context:context,storeConfig:{model:"TypeDefinition",sorters:[{property:"DisplayName"}],fetch:["DisplayName","TypePath"],filters:[{property:"UserListable",operator:"=",value:!0}],autoLoad:!1,remoteSort:!1,sortOnLoad:!0,remoteFilter:!0},displayField:"DisplayName",valueField:"TypePath",listeners:{change:function(combo){combo.fireEvent("typeselected",combo.getValue(),combo.context)},ready:function(combo){combo.store.filterBy(function(record){return Rally.data.ModelTypes.isArtifact(record.get("TypePath"))}),combo.getValue().length||combo.setValue(["HierarchicalRequirement"]),combo.fireEvent("typeselected",combo.getValue(),combo.context)}},bubbleEvents:["typeselected"],readyEvent:"ready",handlesEvents:{projectscopechanged:function(context){this.refreshWithNewContext(context)}}},{name:"aggregationField",xtype:"rallyfieldcombobox",plugins:["rallyfieldvalidationui"],fieldLabel:"Field",readyEvent:"ready",allowBlank:!1,validateOnChange:!1,validateOnBlur:!1,width:300,bubbleEvents:["fieldselected"],handlesEvents:{typeselected:function(models,context){var type=Ext.Array.from(models)[0];type?this.refreshWithNewModelType(type,context):(this.store.removeAll(),this.reset())}},listeners:{ready:function(combo){combo.store.filterBy(function(record){var field=record.get("fieldDefinition"),attr=field.attributeDefinition,whiteList=["Tags","Milestones"];return attr&&!attr.Hidden&&(("COLLECTION"!==attr.AttributeType||field.isMultiValueCustom())&&!field.isMappedFromArtifact||_.contains(whiteList,field.name))});var fields=Ext.Array.map(combo.store.getRange(),function(record){return record.get(combo.getValueField())});Ext.Array.contains(fields,combo.getValue())||combo.setValue(fields[0])}}},{name:"aggregationFieldValues",xtype:"rallyfieldcombobox",plugins:["rallyfieldvalidationui"],fieldLabel:"Field Values",readyEvent:"ready",allowBlank:!1,validateOnChange:!1,validateOnBlur:!1,width:300,handlesEvents:{typeselected:function(models,context){var type=Ext.Array.from(models)[0];type?this.refreshWithNewModelType(type,context):(this.store.removeAll(),this.reset())}},listeners:{ready:function(combo){combo.store.filterBy(function(record){var field=record.get("fieldDefinition"),attr=field.attributeDefinition,whiteList=["Tags","Milestones"];return attr&&!attr.Hidden&&(("COLLECTION"!==attr.AttributeType||field.isMultiValueCustom())&&!field.isMappedFromArtifact||_.contains(whiteList,field.name))});var fields=Ext.Array.map(combo.store.getRange(),function(record){return record.get(combo.getValueField())});Ext.Array.contains(fields,combo.getValue())||combo.setValue(fields[0])}}},{name:"aggregationType",xtype:"rallycombobox",plugins:["rallyfieldvalidationui"],fieldLabel:"Aggregation Type",displayField:"name",valueField:"value",editable:!1,allowBlank:!1,width:300,store:{fields:["name","value"],data:[{name:"Count",value:"count"},{name:"Points",value:"points"}]},lastQuery:""},{type:"query"}]}});
                Ext.define("CfdCalculator",{extend:"Rally.data.lookback.calculator.TimeSeriesCalculator",getMetrics:function(){return _.map(this.stateFieldValues,function(stateFieldValue){return{field:"PlanEstimate",as:stateFieldValue,f:"filteredSum",filterField:this.stateFieldName,filterValues:[stateFieldValue],display:"area"}},this)}});
                Ext.define("CfdChart",{xtype:"cfdchart",extend:"Rally.ui.chart.Chart",requires:["CfdCalculator"],config:{calculatorType:"CfdCalculator",chartColors:["#FF8200","#F6A900","#FAD200","#8DC63F","#1E7C00","#337EC6","#005EB8","#7832A5","#DA1884","#C0C0C0"],chartConfig:{chart:{type:"area"},title:{text:""},subtitle:{text:""},xAxis:{tickmarkPlacement:"on",tickInterval:15,title:{text:"Date"}},yAxis:[{title:{text:"Points"}}],plotOptions:{series:{marker:{enabled:!1}},area:{stacking:"normal"}}}},constructor:function(config){config=config||{},this.mergeConfig(config),this.callParent([this.config])}});
                Ext.define("CustomCfdApp",{extend:"Rally.app.App",componentCls:"app",layout:{type:"vbox",align:"stretch"},items:[{xtype:"container",itemId:"header",height:26},{xtype:"container",itemId:"filterContainer"},{xtype:"container",itemId:"chartContainer",flex:1}],config:{defaultSettings:{types:"HierarchicalRequirement,Defect",aggregationField:"ScheduleState",aggregationType:"count",query:""}},getSettingsFields:function(){return Settings.getSettingsFields(this.getContext())},launch:function(){Rally.data.wsapi.ModelFactory.getModels({types:this._getTypesSetting(),context:this.getContext().getDataContext()}).then({success:this._onModelsLoaded,scope:this})},_onModelsLoaded:function(models){this.models=_.values(models);var blackListFields=[],whiteListFields=["Milestones","Tags"],modelNames=this._getTypesSetting();this.down("#header").add({xtype:"rallyinlinefiltercontrol",context:this.getContext(),height:26,inlineFilterButtonConfig:{stateful:!0,stateId:this.getContext().getScopedStateId("inline-filter"),context:this.getContext(),modelNames:modelNames,filterChildren:!1,inlineFilterPanelConfig:{quickFilterPanelConfig:{defaultFields:["ModelType","ArtifactSearch"],addQuickFilterConfig:{blackListFields:blackListFields,whiteListFields:whiteListFields}},advancedFilterPanelConfig:{advancedFilterRowsConfig:{propertyFieldConfig:{blackListFields:blackListFields,whiteListFields:whiteListFields}}}},listeners:{inlinefilterchange:this._onFilterChange,inlinefilterready:this._onFilterReady,scope:this}}})},_onFilterReady:function(inlineFilterPanel){this.down("#filterContainer").add(inlineFilterPanel)},_onFilterChange:function(inlineFilterButton){this.filterInfo=inlineFilterButton.getTypesAndFilters(),this._loadData()},_loadData:function(){this.down("#chartContainer").removeAll(!0),this.down("#chartContainer").setLoading(!0),Ext.create("Rally.data.wsapi.artifact.Store",{autoLoad:!0,context:this.getContext().getDataContext(),limit:1/0,pageSize:2e3,models:this.filterInfo.types,filters:this.filterInfo.filters.concat(this._getFilters()),fetch:["ObjectID"],listeners:{load:this._onWsapiDataRetrieved,scope:this}})},_onWsapiDataRetrieved:function(store){this.down("#chartContainer").setLoading(!1);var oids=_.map(store.getRange(),function(record){return record.getId()});this._addChart(oids)},_addChart:function(oids){this.down("#chartContainer").add({xtype:"cfdchart",storeType:"Rally.data.lookback.SnapshotStore",context:this.getContext(),storeConfig:{find:{_TypeHierarchy:{$in:this._getTypesSetting()},ObjectID:{$in:oids},Children:null},fetch:["_ValidFrom","_ValidTo",this.getSetting("aggregationField"),"PlanEstimate"],hydrate:[this.getSetting("aggregationField")],compress:!0,useHttpPost:!0},calculatorConfig:{stateFieldName:this.getSetting("aggregationField"),stateFieldValues:["Idea","Defined","In-Progress","Completed","Accepted","Released"]}})},_getTypesSetting:function(){return this.getSetting("types").split(",")},onTimeboxScopeChange:function(){this.callParent(arguments),this._loadData(this.down("#filterButton").getTypesAndFilters())},_getFilters:function(){var queries=[],timeboxScope=this.getContext().getTimeboxScope();return this.getSetting("query")&&queries.push(Rally.data.QueryFilter.fromQueryString(this.getSetting("query"))),timeboxScope&&_.every(this.models,timeboxScope.isApplicable,timeboxScope)&&queries.push(timeboxScope.getQueryFilter()),queries}});

            Rally.launchApp('CustomCfdApp', {
                name:"CustomCfd",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
